<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>kikodo</title>
        <link href="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://cdn.staticfile.org/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
        <link href="http://cdn.staticfile.org/highlight.js/8.0/styles/default.min.css" rel="stylesheet">

        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        <script src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script>
        <script type="text/javascript" src="/js/jquery-scrolltofixed.min.js"></script>
        <script>
          $(document).ready(function () {
            console.log('hi');
            $('.header').scrollToFixed();
          })
        </script>

    </head>
    <body>

        <div class="site">
          <div class="content-container">
            <div class="content-sidebar" style="background: #eee;" >
              <div class="content-sidebar-header">
                <a href="/">
                <img src="/images/avatar.JPG" class="avatar" alt="">
                </a>
              </div>
              <div class="header">
                <h1 class="title text-center"><a href="/">tangkikodo <span>python,js</span></a></h1>
              </div>
              </div>
            <div class="content-mainbar">
              <h1>mongodb using records</h1>
<p class="meta">26 May 2014</p>

<code>待施工</code>


<div class="post">
<h2>mongodb</h2>

<h2>robomongo</h2>

<p>结果排序  </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">db.products.find({},
{&#39;brand_name&#39;:1, &#39;series&#39;:1, &#39;product_name&#39;:1,&#39;volume&#39;:1,&quot;review_summary.count&quot;:1})
.sort({&#39;brand_name&#39;:-1,&#39;product_name&#39;:-1})
</code></pre></div>
<h2>pymongo</h2>

<p>基本用法  </p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()[</span><span class="s">&#39;databas&#39;</span><span class="p">]</span>
<span class="n">reviews</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;review_summary&#39;</span><span class="p">:{</span><span class="s">&#39;$exists&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
<span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">reviews</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">rev</span><span class="p">[</span><span class="s">&#39;product_name&#39;</span><span class="p">])</span></code></pre></div>

<p>ObjectId 可以多,不可以少。。</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()[</span><span class="s">&#39;test&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]))</span>
<span class="n">myid</span> <span class="o">=</span> <span class="s">&quot;53799b0595ca313f2aad412a&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">(</span><span class="n">myid</span><span class="p">))</span>
<span class="c">#所以ObjectId嵌套没有问题的哟</span></code></pre></div>

<p>mongo aggregate!!!<br>
<script src="https://gist.github.com/allmonday/ac24a5e145f2be4eb6fb.js"> </script></p>

<h2>mongo export import dump restore</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">mongodump -h xxx.xxx.xx.x -d jdmilk -o jd
mongorestore -d jdmilk -directoryperdb jd/jdmilk
mongoexport -h xxx.xxx.xx.x -d dev -c mycollection -o mcollection.json
mongoimport -d dev -c mycollection --file mcollection.json
</code></pre></div>
<h2>mongo update</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">from bson.objectid imoprt ObjectId
db.collection.update({&#39;_id&#39;: ObjectId(&quot;xxxxxxxx&quot;), {&quot;$set&quot;:{&#39;target&#39;: &#39;value&#39;}}})
</code></pre></div>
<p>如果在robomongo下对所有记录做set:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">db.products.update({}, {$set: {&#39;industry&#39;: &#39;beer&#39;}}, {multi:true})
</code></pre></div><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">db</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">update</span><span class="p">({},</span> <span class="p">{</span><span class="s">&quot;$unset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;industry&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span> <span class="n">multi</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>
<h2>fucking things in robomongo</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">db.collection.insert({&#39;value&#39;: &#39;好-p&#39;})
</code></pre></div>
<p>it will display <code>好R</code> in robomongo&#39;s GUI, but it is correct inside mongo..</p>

<h2>mongo upsert</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">r = p_item.update({&#39;source&#39;:&#39;taobao&#39;}, {&#39;$set&#39;:{&#39;price&#39;:21}}, upsert=True)
</code></pre></div>
<h2>PyMongo</h2>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">src_</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;_productsIds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">MONGO</span><span class="o">.</span><span class="n">product_item_changes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
        <span class="p">{</span><span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="n">src_</span><span class="p">,</span> <span class="s">&#39;product_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;$in&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">},</span> <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">})))</span>
</code></pre></div>
</div>

<div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'allmonday'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
</div>
            </div>
          </div>
        </div>

    </body>
</html>
